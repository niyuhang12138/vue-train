<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <body>
        <h1>Vue</h1>
        <div id="app"></div>
        <script type="module">
            // reactive 创建一个响应式对象
            // effect 副作用函数 默认会执行一次， 数据变化后会再次执行
            import {
                reactive,
                effect,
                computed,
                watch,
                watchEffect,
            } from "../dist/reactivity.esm.js";
            // import {
            //     reactive,
            //     effect,
            // } from "/node_modules/@vue/reactivity/dist/reactivity.esm-browser.js";

            const state = reactive({
                flag: false,
                name: "zs",
                age: 19,
                o: {
                    o_i: {
                        str: "hello",
                    },
                },
            });

            // 当数据变化后， 我希望根据最新的数据 获取结果
            // 第一次数据变化了， 我会调用一个接口 getData() 2000ms -> 返回一个值 1
            // 第二次数据变化了， 我会调用一个接口 getData() 1000ms -> 返回一个值 2

            // 最终页面显示的结果是： 2

            // 第一次接口速度比较慢， 第二次比较快， 但是第一次的结果会覆盖调第二次的

            const app = document.getElementById("app");

            let timer = 3000;

            function getData(data) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(data);
                    }, (timer -= 1000));
                });
            }

            // Vue2中如何解决
            // let arr = [];
            // watch(
            //     () => state.name,
            //     async (newValue, oldValue) => {
            //         let flag = true;
            //
            //         while (arr.length) {
            //             const fn = arr.shift();
            //             fn();
            //         }
            //
            //         arr.push(() => (flag = false));
            //
            //         const res = await getData(newValue);
            //         if (flag) {
            //             app.innerHTML = `<h1>${res}</h1>`;
            //         }
            //     }
            // );

            // Vue3结局色方案
            watch(
                () => state.name,
                async (newValue, oldValue, onCleanup) => {
                    let flag = true;

                    onCleanup(() => (flag = false));

                    const res = await getData(newValue);
                    if (flag) {
                        app.innerHTML = `<h1>${res}</h1>`;
                    }
                },
                { immediate: true, flush: "post" }
            );

            state.name = "ls";
            state.name = "ww";
        </script>
    </body>
</html>
